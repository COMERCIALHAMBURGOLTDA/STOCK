<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>STOCK VALORIZADO HAMBURGO</title>
  <!-- Plotly para lectura de CSV y gráficos -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      color: #333;
    }
    h1 {
      text-align: center;
      margin: 20px 0;
      font-size: 2rem;
      color: #1a1a1a;
    }

    /* Contenedor global */
    .section-wrapper {
      max-width: 1600px;
      margin: 40px auto;
      padding: 0 20px;
    }
    .section-wrapper h1.section-title {
      font-size: 1.8rem;
      color: #005a9e;
      margin-bottom: 20px;
      border-bottom: 2px solid #005a9e;
      padding-bottom: 6px;
    }

    /* Fondo blanco para cada sección */
    .section {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin: 20px 0;
      padding: 20px;
    }
    .section .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .section .section-header h2 {
      margin: 0;
      font-size: 1.4rem;
      color: #333;
    }

    /* Secciones estrechas */
    .narrow-section {
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Tablas */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
    }
    th, td {
      padding: 8px 12px;
      text-align: center;
      font-size: 0.95rem;
      white-space: nowrap;
    }
    th {
      background-color: #007acc;
      color: #fff;
      font-weight: 600;
      border-bottom: 2px solid #005a9e;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    tr:hover {
      background-color: #d9edf7;
      cursor: default;
    }
    tr.total-row {
      background-color: #cccccc;
      font-weight: bold;
    }

    /* Animaciones para parpadeo */
    @keyframes parpadeo-morado {
  0%, 100% { background-color: rgba(128, 0, 128, 0.7); }
  50%      { background-color: transparent; }
}
.blink-purple {
  animation: parpadeo-morado 2s infinite;
}

@keyframes parpadeo-rojo {
  0%, 100% { background-color: rgba(255, 0, 0, 0.7); }
  50%      { background-color: transparent; }
}
.blink-red {
  animation: parpadeo-rojo 2s infinite;
}

@keyframes parpadeo-amarillo {
  0%, 100% { background-color: rgba(255, 255, 0, 0.7); }
  50%      { background-color: transparent; }
}
.blink-yellow {
  animation: parpadeo-amarillo 2s infinite;
}


    /* Filtros (Vencimientos) */
    #filtrosV {
      text-align: center;
      margin-bottom: 10px;
    }
    #filtrosV button {
      margin: 0 5px;
      padding: 6px 10px;
      font-size: 0.9rem;
      border: 1px solid #005a9e;
      border-radius: 4px;
      background-color: #fff;
      color: #005a9e;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
    }
    #filtrosV button:hover {
      background-color: #e0f0ff;
    }
    #filtrosV button.active {
      background-color: #005a9e;
      color: #fff;
    }

    /* Filtros (Otros) */
    .filters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    .filter-group {
      display: flex;
      align-items: center;
      font-size: 0.95rem;
    }
    .filter-group label {
      margin-right: 6px;
      font-weight: 500;
    }
    .filter-group select {
      padding: 4px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #fff;
      font-size: 0.95rem;
    }

    /* Gráficos */
    .chart-container {
      width: 100%;
      height: 400px;
      margin-top: 10px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 2% auto;
      padding: 20px;
      border-radius: 8px;
      width: 95%;
      max-width: 1200px;
      position: relative;
      overflow-x: auto;
    }
    .modal-close {
      position: absolute;
      top: 10px; right: 15px;
      font-size: 1.5rem;
      font-weight: bold;
      color: #555;
      cursor: pointer;
    }
    .modal table {
      margin-bottom: 0;
      width: 100%;
    }
    .modal th, .modal td {
      font-size: 0.9rem;
      padding: 6px 10px;
      white-space: normal;
      word-break: break-word;
      text-align: left;
    }
    .modal th {
      background-color: #005a9e;
      color: #fff;
      text-align: center;
      text-transform: uppercase;
    }
    .modal tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .modal tr.total-row {
      background-color: #e6e6e6;
    }

    /* Ajustes para pantallas muy pequeñas */
    @media (max-width: 600px) {
      th, td {
        padding: 6px 8px;
        font-size: 0.85rem;
      }
      table {
        font-size: 0.85rem;
      }
      #filtrosV button {
        margin: 3px 2px;
        padding: 4px 6px;
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <h1>Dashboard</h1>

  <div class="section-wrapper">
    <h1 class="section-title">STOCK VALORIZADO</h1>

    <!-- POR BODEGA (contenedor estrecho) -->
    <div class="section narrow-section" id="sectionBodega">
      <div class="section-header">
        <h2>Por Bodega</h2>
      </div>
      <div id="tablaBodega"></div>
      <div class="chart-container">
        <div id="chartBodega" style="width:100%; height:100%;"></div>
      </div>
    </div>

    <!-- POR FAMILIA (contenedor estrecho) -->
    <div class="section narrow-section" id="sectionFamilia">
      <div class="section-header">
        <h2>Por Familia</h2>
      </div>
      <div class="filters">
        <div class="filter-group">
          <label for="bodegaFilter">Bodega:</label>
          <select id="bodegaFilter">
            <option value="Todas">Todas</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="nivelFilter">Nivel:</label>
          <select id="nivelFilter" disabled>
            <option value="Todos">Todos</option>
          </select>
        </div>
      </div>
      <div id="tablaFamilia"></div>
      <div class="chart-container">
        <div id="chartFamilia" style="width:100%; height:100%;"></div>
      </div>
    </div>

    <!-- VENCIMIENTOS PRÓXIMOS -->
    <div class="section" id="sectionVencimientos">
      <div class="section-header">
        <h2>Vencimientos</h2>
      </div>
      <!-- Botones de filtro para Vencimientos -->
      <div id="filtrosV">
        <button id="btn30" data-filter="30" onclick="toggleFilter('30')">
          Vencidos o &lt; 30 días
        </button>
        <button id="btn60" data-filter="60" onclick="toggleFilter('60')">
          31–60 días
        </button>
        <button id="btn90" data-filter="90" onclick="toggleFilter('90')">
          61–90 días
        </button>
        <button id="btn91" data-filter="91" onclick="toggleFilter('91')">
          &gt; 90 días
        </button>
        <button id="btnAll" data-filter="all" onclick="toggleFilter('all')">
          TODO STOCK
        </button>
      </div>
      <div id="tablaVencimientos"></div>
    </div>

    <!-- RESUMEN DE UBICACIONES POR ESTADO (CSV Adicional) -->
    <div class="section narrow-section" id="sectionResumenEstado">
      <div class="section-header">
        <h2>RESUMEN UBICACIONES DISPONIBLES</h2>
      </div>
      <div class="filters">
        <div class="filter-group">
          <label for="filterBodegaAd">Bodega:</label>
          <select id="filterBodegaAd">
            <option value="Todas">Todas</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filterRackeoAd">Rackeo:</label>
          <select id="filterRackeoAd">
            <option value="Todos">Todos</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filterNivelAd">Nivel:</label>
          <select id="filterNivelAd" disabled>
            <option value="Todos">Todos</option>
          </select>
        </div>
      </div>
      <div id="tablaResumenEstado"></div>
      <div class="chart-container">
        <div id="chartResumenEstado" style="width:100%; height:100%;"></div>
      </div>
    </div>

  </div>

  <!-- MODAL PARA MOSTRAR PRODUCTOS -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="modalClose">&times;</span>
      <h2 id="modalTitle">Productos</h2>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    // --------------------------------------------------------
    // Variables de filtro para Vencimientos
    let currentFilter = '30'; // Por defecto, mostrar ≤ 30 días
    // Cambia o quita el filtro: si se hace clic en el mismo filtro activo, vuelve a 'all'
    function toggleFilter(filterValue) {
      if (currentFilter === filterValue) {
        currentFilter = 'all';
      } else {
        currentFilter = filterValue;
      }
      actualizarBotones();
      dibujarTablaVencimientos();
    }
    // Actualiza clases "active" en botones según currentFilter
    function actualizarBotones() {
      const botones = document.querySelectorAll('#filtrosV button');
      botones.forEach(btn => {
        const valor = btn.getAttribute('data-filter');
        if (valor === currentFilter) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    // URLs CSV
    const CSV_URL_BASE =
      "https://docs.google.com/spreadsheets/d/e/" +
      "2PACX-1vQNpc-4hMLcvSv4pO4Zirf528ePaScC-l6OGPS5nU_4peDVfs3ur6ih5row8HUs6_BKkoIQhvPvDMiv" +
      "/pub?gid=208523845&single=true&output=csv";
    const CSV_URL_ADICIONAL =
      "https://docs.google.com/spreadsheets/d/e/" +
      "2PACX-1vQNpc-4hMLcvSv4pO4Zirf528ePaScC-l6OGPS5nU_4peDVfs3ur6ih5row8HUs6_BKkoIQhvPvDMiv" +
      "/pub?gid=603155343&single=true&output=csv";

    let datosVálidos = [];
    let bodegasUnicas = [];
    let nivelesUnicos = [];
    let resumenBodega = [];
    let granTotalBodega = 0;
    let datosCsvAdicional = [];

    // ----------------------------------------------------------
    // 1) Carga y procesamiento del CSV principal (UBICACIONES)
    // ----------------------------------------------------------
    Plotly.d3.csv(CSV_URL_BASE, function(err, rows) {
      if (err) {
        console.error("Error al cargar el CSV principal:", err);
        document.getElementById("tablaBodega").innerText = "No se pudieron cargar los datos.";
        document.getElementById("tablaFamilia").innerText = "No se pudieron cargar los datos.";
        document.getElementById("tablaVencimientos").innerText = "No se pudieron cargar los datos.";
        return;
      }

      // Parseo inicial: convertir “TOTAL $” a número y parsear “FECHA VENCIMIENTO”
      datosVálidos = rows.map(r => {
        r["TOTAL $"] = +r["TOTAL $"];
        const fechaRaw = r["FECHA VENCIMIENTO"];
        let fechaObj;
        if (fechaRaw.includes("/")) {
          const parts = fechaRaw.split("/");
          fechaObj = new Date(+parts[2], +parts[1] - 1, +parts[0]);
        } else {
          fechaObj = new Date(fechaRaw);
        }
        r["_FECHA"] = fechaObj;
        return r;
      }).filter(r =>
        r["BODEGA"]?.trim() &&
        r["NIVEL"]?.trim() &&
        r["FAMILIA"]?.trim() &&
        !isNaN(r["TOTAL $"]) &&
        r["_FECHA"] instanceof Date &&
        !isNaN(r["_FECHA"])
      );

      // Extraer listas únicas de BODEGA y NIVEL (para filtros)
      bodegasUnicas = Array.from(new Set(datosVálidos.map(r => r["BODEGA"]))).sort();
      nivelesUnicos  = Array.from(new Set(datosVálidos.map(r => r["NIVEL"]))).sort();

      poblarFiltroBodega();
      updateNivelOptions("Todas");

      // Construir resumen “Por Bodega”
      const mapB = {};
      datosVálidos.forEach(r => {
        mapB[r["BODEGA"]] = (mapB[r["BODEGA"]] || 0) + r["TOTAL $"];
      });
      resumenBodega = Object.keys(mapB).map(b => {
        const rawSum = mapB[b];
        const truncSum = Math.trunc(rawSum);
        return { clave: b, totalInt: truncSum };
      });
      resumenBodega.sort((a, b) => b.totalInt - a.totalInt);
      granTotalBodega = resumenBodega.reduce((acc, x) => acc + x.totalInt, 0);

      resumenBodega = resumenBodega.map(row => {
        const pct = granTotalBodega > 0 ? (row.totalInt / granTotalBodega) * 100 : 0;
        return {
          clave: row.clave,
          totalFmt: row.totalInt.toLocaleString("es-CL", { minimumFractionDigits: 0 }),
          pctFmt: pct.toLocaleString("es-CL", { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + " %",
          totalNumRaw: row.totalInt
        };
      });
      // Agregar fila de total general
      resumenBodega.push({
        clave: "Suma total",
        totalFmt: granTotalBodega.toLocaleString("es-CL", { minimumFractionDigits: 0 }),
        pctFmt: "100 %",
        totalNumRaw: granTotalBodega
      });

      // Render “Por Bodega”
      dibujarTabla("tablaBodega", "BODEGA", resumenBodega);
      dibujarGraficoCircular(
        "chartBodega",
        resumenBodega.filter(r => r.clave !== "Suma total").map(r => r.clave),
        resumenBodega.filter(r => r.clave !== "Suma total").map(r => r.totalNumRaw),
        "<b>Total $ por Bodega</b>"
      );

      // Inicializar “Por Familia”
      actualizarFamiliaYNivel("Todas", "Todos");

      // Configurar botones de filtro de Vencimientos y dibujar por primera vez
      actualizarBotones();
      dibujarTablaVencimientos();

      // Carga y resumen de CSV Adicional para Resumen de Ubicaciones por Estado
      cargarYResumenUbicacionesPorEstado();
    });

    // ----------------------------------------------------------
    // 2) Función para dibujar “Vencimientos” con filtros
    // ----------------------------------------------------------
    function dibujarTablaVencimientos() {
      const hoy = new Date();
      // Filtrar según currentFilter
      let itemsFiltrados = datosVálidos.slice();
      itemsFiltrados = itemsFiltrados.filter(r => {
        const diffDias = Math.floor((r["_FECHA"] - hoy) / (1000 * 60 * 60 * 24));
        if (currentFilter === '30') {
          return diffDias <= 30;
        } else if (currentFilter === '60') {
          return diffDias >= 31 && diffDias <= 60;
        } else if (currentFilter === '90') {
          return diffDias >= 61 && diffDias <= 90;
        } else if (currentFilter === '91') {
          return diffDias > 90;
        } else if (currentFilter === 'all') {
          return true;
        }
        return false;
      });
      // Ordenar por fecha ascendente
      itemsFiltrados.sort((a, b) => a["_FECHA"] - b["_FECHA"]);

      let sumMonto = 0;
      let html = `<table>
                    <thead>
                      <tr>
                        <th>UBICACIÓN</th>
                        <th>CÓDIGO VENTA</th>
                        <th>DESCRIPCIÓN</th>
                        <th>FECHA VENCIMIENTO</th>
                        <th>DÍAS FALTANTES</th>
                        <th>UNIDADES</th>
                        <th>BULTOS</th>
                        <th>MONTO</th>
                      </tr>
                    </thead>
                    <tbody>`;

      if (itemsFiltrados.length === 0) {
        html += `<tr><td colspan="8">No hay productos para el filtro seleccionado.</td></tr>`;
      } else {
        itemsFiltrados.forEach(r => {
          const d = r["_FECHA"];
          const diffDias = Math.floor((d - hoy) / (1000 * 60 * 60 * 24));
          const ubic = `${r["BODEGA"]}-${r["NIVEL"]}-${r["PASILLO"]}-${r["RACK"]}`;
          const montoTrunc = Math.trunc(r["TOTAL $"]);
          const unidadesMostrar = r["UNIDADES"] || 0;
          const nivelUpper = r["NIVEL"].toUpperCase();
          const fuerzaCeroBultos = nivelUpper.includes("PICKEO") || nivelUpper.includes("CHICLES");
          const bultosMostrar = fuerzaCeroBultos ? 0 : (r["BULTOS"] || 0);
          sumMonto += montoTrunc;

          const dd = String(d.getDate()).padStart(2, "0");
          const mm = String(d.getMonth() + 1).padStart(2, "0");
          const yyyy = d.getFullYear();
          const fechaFmt = `${dd}/${mm}/${yyyy}`;

          // Asignar clase según diffDias:
          //   < 0 → .blink-purple
          //   1–15 → .blink-red
          //   16–30 → .blink-yellow
          let claseFila = "";
          if (diffDias < 0) {
            claseFila = "blink-purple";
          } else if (diffDias >= 1 && diffDias <= 15) {
            claseFila = "blink-red";
          } else if (diffDias >= 16 && diffDias <= 30) {
            claseFila = "blink-yellow";
          }

          html += `<tr class="${claseFila}">
                     <td>${ubic}</td>
                     <td>${r["CODIGO VENTA"] || ""}</td>
                     <td>${r["DESCRIPCION"] || ""}</td>
                     <td>${fechaFmt}</td>
                     <td>${diffDias}</td>
                     <td>${unidadesMostrar}</td>
                     <td>${bultosMostrar}</td>
                     <td>${montoTrunc.toLocaleString("es-CL", { minimumFractionDigits: 0 })}</td>
                   </tr>`;
        });

        html += `<tr class="total-row">
                   <td colspan="7"></td>
                   <td><strong>${sumMonto.toLocaleString("es-CL", { minimumFractionDigits: 0 })}</strong></td>
                 </tr>`;
      }

      html += `</tbody></table>`;
      document.getElementById("tablaVencimientos").innerHTML = html;
    }

    // ----------------------------------------------------------
    // 3) Funciones para “Por Familia” (filtros de Bodega y Nivel)
    // ----------------------------------------------------------
    function poblarFiltroBodega() {
      const selectBod = document.getElementById("bodegaFilter");
      bodegasUnicas.forEach(bod => {
        const opt = document.createElement("option");
        opt.value = bod;
        opt.text = bod;
        selectBod.appendChild(opt);
      });
      selectBod.addEventListener("change", function() {
        const selB = this.value;
        updateNivelOptions(selB);
        const selN = document.getElementById("nivelFilter").value;
        actualizarFamiliaYNivel(selB, selN);
      });
    }

    function updateNivelOptions(bodegaSeleccionada) {
      const selectNiv = document.getElementById("nivelFilter");
      selectNiv.innerHTML = "";
      if (bodegaSeleccionada === "Todas") {
        const optTodos = document.createElement("option");
        optTodos.value = "Todos";
        optTodos.text = "Todos";
        selectNiv.appendChild(optTodos);
        selectNiv.disabled = true;
        return;
      }
      selectNiv.disabled = false;
      const optTodos = document.createElement("option");
      optTodos.value = "Todos";
      optTodos.text = "Todos";
      selectNiv.appendChild(optTodos);

      const setNiv = new Set(
        datosVálidos
          .filter(r => r["BODEGA"] === bodegaSeleccionada)
          .map(r => r["NIVEL"])
      );
      Array.from(setNiv).sort().forEach(niv => {
        const opt = document.createElement("option");
        opt.value = niv;
        opt.text = niv;
        selectNiv.appendChild(opt);
      });

      selectNiv.addEventListener("change", function() {
        const selN = this.value;
        const selB = document.getElementById("bodegaFilter").value;
        actualizarFamiliaYNivel(selB, selN);
      });
    }

    function actualizarFamiliaYNivel(bodegaSeleccionada, nivelSeleccionado) {
      let datosFiltrados = datosVálidos.slice();
      if (bodegaSeleccionada !== "Todas") {
        datosFiltrados = datosFiltrados.filter(r => r["BODEGA"] === bodegaSeleccionada);
      }
      if (nivelSeleccionado !== "Todos") {
        datosFiltrados = datosFiltrados.filter(r => r["NIVEL"] === nivelSeleccionado);
      }

      // Agrupar por FAMILIA
      const mapFamilia = {};
      datosFiltrados.forEach(r => {
        mapFamilia[r["FAMILIA"]] = (mapFamilia[r["FAMILIA"]] || 0) + r["TOTAL $"];
      });
      let resumenFamilia = Object.keys(mapFamilia).map(f => {
        const rawSum = mapFamilia[f];
        const truncated = Math.trunc(rawSum);
        return { clave: f, totalInt: truncated };
      });
      resumenFamilia.sort((a, b) => b.totalInt - a.totalInt);
      const granTotalFamilia = resumenFamilia.reduce((acc, x) => acc + x.totalInt, 0);

      resumenFamilia = resumenFamilia.map(row => {
        const pct = granTotalFamilia > 0 ? (row.totalInt / granTotalFamilia) * 100 : 0;
        return {
          clave: row.clave,
          totalFmt: row.totalInt.toLocaleString("es-CL", { minimumFractionDigits: 0 }),
          pctFmt: pct.toLocaleString("es-CL", { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + " %",
          totalNumRaw: row.totalInt
        };
      });
      if (granTotalFamilia > 0) {
        resumenFamilia.push({
          clave: "Suma total",
          totalFmt: granTotalFamilia.toLocaleString("es-CL", { minimumFractionDigits: 0 }),
          pctFmt: "100 %",
          totalNumRaw: granTotalFamilia
        });
      } else {
        resumenFamilia = [{
          clave: "Sin datos",
          totalFmt: "0",
          pctFmt: "0,0 %",
          totalNumRaw: 0
        }];
      }

      dibujarTabla("tablaFamilia", "FAMILIA", resumenFamilia, datosFiltrados);

      const labelsFam = resumenFamilia
        .filter(r => r.clave !== "Suma total" && r.clave !== "Sin datos")
        .map(r => r.clave);
      const valuesFam = resumenFamilia
        .filter(r => r.clave !== "Suma total" && r.clave !== "Sin datos")
        .map(r => r.totalNumRaw);

      const tituloGrafFamilia =
        "<b>Total $ por Familia</b>" +
        (bodegaSeleccionada !== "Todas" ? ` (Bodega: ${bodegaSeleccionada})` : "") +
        (nivelSeleccionado !== "Todos" ? ` / Nivel: ${nivelSeleccionado}` : "");

      dibujarGraficoCircular("chartFamilia", labelsFam, valuesFam, tituloGrafFamilia);
    }

    function dibujarTabla(containerId, tituloColumna, dataArr, datosFiltrados = []) {
      let html = `<table>
                    <thead>
                      <tr>
                        <th>${tituloColumna}</th>
                        <th>VALORIZADO</th>
                        <th>% DEL TOTAL</th>
                      </tr>
                    </thead>
                    <tbody>`;
      dataArr.forEach(row => {
        const isTotal = row.clave === "Suma total" || row.clave === "Sin datos";
        const labelCell = isTotal
          ? `<strong>${isTotal && row.clave === "Suma total" ? "TOTAL VALORIZADO" : "Sin datos"}</strong>`
          : row.clave;

        const valorCelda = isTotal
          ? `<strong>${row.totalFmt}</strong>`
          : row.totalFmt;
        const pctCelda = isTotal
          ? `<strong>${row.pctFmt}</strong>`
          : row.pctFmt;

        html += `<tr class="${isTotal ? "total-row" : ""}" data-family="${row.clave}">
                   <td>${labelCell}</td>
                   <td>${valorCelda}</td>
                   <td>${pctCelda}</td>
                 </tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById(containerId).innerHTML = html;

      if (containerId === "tablaFamilia") {
        document.querySelectorAll("#tablaFamilia tbody tr").forEach(tr => {
          const fam = tr.getAttribute("data-family");
          if (fam && fam !== "Suma total" && fam !== "Sin datos") {
            tr.addEventListener("click", () => mostrarProductosDeFamilia(fam));
          }
        });
      }
    }

    function mostrarProductosDeFamilia(familyName) {
      const bodegaSeleccionada = document.getElementById("bodegaFilter").value;
      const nivelSeleccionado = document.getElementById("nivelFilter").value || "Todos";

      let productos = datosVálidos.slice();
      if (bodegaSeleccionada !== "Todas") {
        productos = productos.filter(r => r["BODEGA"] === bodegaSeleccionada);
      }
      if (nivelSeleccionado !== "Todos") {
        productos = productos.filter(r => r["NIVEL"] === nivelSeleccionado);
      }
      productos = productos.filter(r => r["FAMILIA"] === familyName);
      productos.sort((a, b) => a._FECHA - b._FECHA);

      let totalValorizado = 0;
      let html = `<table>
                    <thead>
                      <tr>
                        <th>UBICACIÓN</th>
                        <th>CÓDIGO VENTA</th>
                        <th>DESCRIPCIÓN</th>
                        <th>UNIDADES</th>
                        <th>BULTOS</th>
                        <th>TOTAL $</th>
                        <th>FECHA VENCIMIENTO</th>
                      </tr>
                    </thead>
                    <tbody>`;
      productos.forEach(r => {
        const d = r["_FECHA"];
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yyyy = d.getFullYear();
        const fechaFmt = `${dd}/${mm}/${yyyy}`;
        const ubic = `${r["BODEGA"]}-${r["NIVEL"]}-${r["PASILLO"]}-${r["RACK"]}`;

        const nivelUpper = r["NIVEL"].toUpperCase();
        const fuerzaCeroBultos = nivelUpper.includes("PICKEO") || nivelUpper.includes("CHICLES");
        const bultosMostrar = fuerzaCeroBultos ? 0 : (r["BULTOS"] || 0);
        const unidadesMostrar = r["UNIDADES"] || 0;

        const valorTrunc = Math.trunc(r["TOTAL $"]);
        html += `<tr>
                   <td>${ubic}</td>
                   <td>${r["CODIGO VENTA"] || ""}</td>
                   <td>${r["DESCRIPCION"] || ""}</td>
                   <td>${unidadesMostrar}</td>
                   <td>${bultosMostrar}</td>
                   <td>${valorTrunc.toLocaleString("es-CL", { minimumFractionDigits: 0 })}</td>
                   <td>${fechaFmt}</td>
                 </tr>`;
        totalValorizado += valorTrunc;
      });
      const totalFmt = Math.trunc(totalValorizado).toLocaleString("es-CL", { minimumFractionDigits: 0 });
      html += `<tr class="total-row">
                 <td></td>
                 <td></td>
                 <td><strong>TOTAL VALORIZADO</strong></td>
                 <td></td>
                 <td></td>
                 <td><strong>${totalFmt}</strong></td>
                 <td></td>
               </tr>`;
      html += `</tbody></table>`;

      document.getElementById("modalTitle").innerText = `Productos - Familia: ${familyName}`;
      document.getElementById("modalBody").innerHTML = html;
      document.getElementById("productModal").style.display = "block";
    }

    function dibujarGraficoCircular(containerId, labels, values, title) {
      const truncatedValues = values.map(v => Math.trunc(v));
      const formattedVals = truncatedValues.map(v =>
        "$" + v.toLocaleString("es-CL", { minimumFractionDigits: 0 })
      );

      const palette = [
        "#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd",
        "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"
      ];
      const colors = labels.map((_, i) => palette[i % palette.length]);

      const trace = {
        labels: labels,
        values: truncatedValues,
        type: "pie",
        marker: { colors: colors, line: { color: "#fff", width: 1 } },
        textinfo: "label+percent",
        textfont: {
          size: 14,
          family: "Arial Black, Arial, sans-serif",
          color: "#000"
        },
        customdata: formattedVals,
        hovertemplate: "%{label} %{customdata}<br>%{percent}",
        showlegend: true
      };

      const layout = {
        title: {
          text: title,
          font: {
            size: 20,
            family: "Arial Black, Arial, sans-serif",
            color: "#000"
          }
        },
        font: {
          size: 14,
          family: "Arial Black, Arial, sans-serif",
          color: "#000"
        },
        legend: {
          orientation: "v",
          x: 1.02,
          y: 0.5,
          font: {
            size: 14,
            family: "Arial Black, Arial, sans-serif",
            color: "#000"
          }
        },
        margin: { t: 80, b: 20, l: 20, r: 100 }
      };

      Plotly.newPlot(containerId, [trace], layout, {
        responsive: true,
        displayModeBar: false
      });
    }

    // ----------------------------------------------------------
    // 4) Cargar CSV adicional, normalizar cabeceras y preparar filtros, resumen
    // ----------------------------------------------------------
    function cargarYResumenUbicacionesPorEstado() {
      Plotly.d3.csv(CSV_URL_ADICIONAL, function(err, rows) {
        if (err) {
          console.error("Error al cargar el CSV adicional:", err);
          document.getElementById("tablaResumenEstado").innerText = "No se pudieron cargar los datos.";
          return;
        }
        if (!rows || rows.length < 1) {
          document.getElementById("tablaResumenEstado").innerText = "No hay datos.";
          return;
        }

        // 1) Normalizar todas las cabeceras (trim de key) en cada fila
        // 2) Tomar únicamente las primeras 812 filas (índices 0–811)
        datosCsvAdicional = rows.slice(0, 812).map(r => {
          const norm = {};
          Object.keys(r).forEach(k => {
            const kTrim = k.trim();
            norm[kTrim] = r[k].trim();
          });
          return norm;
        });

        // Poblar filtro de BODEGA y RACKEO
        poblarFiltrosCsvAdicional();
        // No poblamos NIVEL aquí: se hará cuando el usuario elija una bodega

        // Generar resumen inicial con filtros “Todas” / “Todos” / “Todos”
        generarResumenEstado();
      });
    }

    // Poblar filtros para CSV Adicional (Bodega y Rackeo)
    function poblarFiltrosCsvAdicional() {
      const selectBodAd = document.getElementById("filterBodegaAd");
      const selectRackeoAd = document.getElementById("filterRackeoAd");
      const selectNivelAd = document.getElementById("filterNivelAd");

      const setBod = new Set();
      const setRackeo = new Set();

      datosCsvAdicional.forEach(r => {
        const b = (r["BODEGA"] || "").toString().trim();
        const rack = (r["RACKEO"] || "").toString().trim().toUpperCase();
        if (b) setBod.add(b);
        if (rack && rack !== "TRANSITO") setRackeo.add(rack);
      });

      Array.from(setBod).sort().forEach(b => {
        const opt = document.createElement("option");
        opt.value = b;
        opt.text = b;
        selectBodAd.appendChild(opt);
      });
      Array.from(setRackeo).sort().forEach(rk => {
        const opt = document.createElement("option");
        opt.value = rk;
        opt.text = rk;
        selectRackeoAd.appendChild(opt);
      });

      selectNivelAd.disabled = true;

      selectBodAd.addEventListener("change", function() {
        const selB = this.value;
        actualizarNivelOptionsAd(selB);
        generarResumenEstado();
      });
      selectRackeoAd.addEventListener("change", generarResumenEstado);
      selectNivelAd.addEventListener("change", generarResumenEstado);
    }

    // Actualizar opciones de Nivel para CSV Adicional
    function actualizarNivelOptionsAd(bodegaSeleccionada) {
      const selectNivelAd = document.getElementById("filterNivelAd");
      selectNivelAd.innerHTML = "";

      if (bodegaSeleccionada === "Todas") {
        const optTodos = document.createElement("option");
        optTodos.value = "Todos";
        optTodos.text = "Todos";
        selectNivelAd.appendChild(optTodos);
        selectNivelAd.disabled = true;
        return;
      }

      selectNivelAd.disabled = false;
      const optTodos = document.createElement("option");
      optTodos.value = "Todos";
      optTodos.text = "Todos";
      selectNivelAd.appendChild(optTodos);

      const setNivel = new Set();
      datosCsvAdicional.forEach(r => {
        const b = (r["BODEGA"] || "").toString().trim();
        const rack = (r["RACKEO"] || "").toString().trim().toUpperCase();
        const niv = (r["NIVEL"] || "").toString().trim();
        if (
          b === bodegaSeleccionada &&
          rack !== "TRANSITO" &&
          niv &&
          niv.toUpperCase() !== "TRANSITO"
        ) {
          setNivel.add(niv);
        }
      });

      Array.from(setNivel).sort().forEach(nv => {
        const opt = document.createElement("option");
        opt.value = nv;
        opt.text = nv;
        selectNivelAd.appendChild(opt);
      });
    }

    // Generar resumen por Estado para CSV Adicional
    function generarResumenEstado() {
      const selBod = document.getElementById("filterBodegaAd").value;
      const selRack = document.getElementById("filterRackeoAd").value;
      const selNivel = document.getElementById("filterNivelAd").value;

      let filtrados = datosCsvAdicional.filter(r => {
        const estadoRaw = (r["ESTADO"] || "").toString().trim().toUpperCase();
        const rackeoRaw = (r["RACKEO"] || "").toString().trim().toUpperCase();
        if (estadoRaw === "TRANSITO" || rackeoRaw === "TRANSITO") return false;
        return true;
      });

      if (selBod !== "Todas") {
        filtrados = filtrados.filter(r => {
          const b = (r["BODEGA"] || "").toString().trim();
          return b === selBod;
        });
      }
      if (selRack !== "Todos") {
        filtrados = filtrados.filter(r => (r["RACKEO"] || "").toString().trim().toUpperCase() === selRack);
      }
      if (!document.getElementById("filterNivelAd").disabled && selNivel !== "Todos") {
        filtrados = filtrados.filter(r => (r["NIVEL"] || "").toString().trim() === selNivel);
      }

      const conteoPorEstado = { "DISPONIBLE": 0, "NO DISPONIBLE": 0 };
      let totalConsiderado = 0;
      filtrados.forEach(r => {
        const estadoRaw = (r["ESTADO"] || "").toString().trim().toUpperCase();
        if (estadoRaw === "DISPONIBLE") {
          conteoPorEstado["DISPONIBLE"]++;
          totalConsiderado++;
        } else if (estadoRaw === "NO DISPONIBLE") {
          conteoPorEstado["NO DISPONIBLE"]++;
          totalConsiderado++;
        }
      });

      const resumenEstArr = [
        {
          estado: "DISPONIBLE",
          cuenta: conteoPorEstado["DISPONIBLE"],
          pct: totalConsiderado > 0
                 ? ((conteoPorEstado["DISPONIBLE"] / totalConsiderado) * 100)
                     .toLocaleString("es-CL", { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + " %"
                 : "0,0 %"
        },
        {
          estado: "NO DISPONIBLE",
          cuenta: conteoPorEstado["NO DISPONIBLE"],
          pct: totalConsiderado > 0
                 ? ((conteoPorEstado["NO DISPONIBLE"] / totalConsiderado) * 100)
                     .toLocaleString("es-CL", { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + " %"
                 : "0,0 %"
        }
      ];
      resumenEstArr.push({
        estado: "Total",
        cuenta: totalConsiderado,
        pct: totalConsiderado > 0 ? "100 %" : "0,0 %"
      });

      let htmlEstado = `<table>
                          <thead>
                            <tr>
                              <th>ESTADO</th>
                              <th>UBICACIONES</th>
                              <th>% del total</th>
                            </tr>
                          </thead>
                          <tbody>`;
      resumenEstArr.forEach(row => {
        const isTotal = (row.estado === "Total");
        htmlEstado += `<tr class="${isTotal ? "total-row" : ""}">
                         <td>${row.estado}</td>
                         <td>${row.cuenta}</td>
                         <td>${row.pct}</td>
                       </tr>`;
      });
      htmlEstado += `</tbody></table>`;
      document.getElementById("tablaResumenEstado").innerHTML = htmlEstado;

      const labels = resumenEstArr
        .filter(r => r.estado !== "Total")
        .map(r => r.estado);
      const values = resumenEstArr
        .filter(r => r.estado !== "Total")
        .map(r => r.cuenta);

      const formattedVals = values.map(v =>
        v.toLocaleString("es-CL", { minimumFractionDigits: 0 })
      );
      const palette = ["#1f77b4", "#ff7f0e"];
      const colors = labels.map((_, i) => palette[i % palette.length]);
      const trace = {
        labels: labels,
        values: values,
        type: "pie",
        marker: { colors: colors, line: { color: "#fff", width: 1 } },
        textinfo: "label+percent",
        textfont: {
          size: 14,
          family: "Arial Black, Arial, sans-serif",
          color: "#000"
        },
        customdata: formattedVals,
        hovertemplate: "%{label} %{customdata}<br>%{percent}",
        showlegend: true
      };
      const layout = {
        title: {
          text: "<b>Distribución de Ubicaciones por Estado</b>",
          font: {
            size: 20,
            family: "Arial Black, Arial, sans-serif",
            color: "#000"
          }
        },
        font: {
          size: 14,
          family: "Arial Black, Arial, sans-serif",
          color: "#000"
        },
        legend: {
          orientation: "v",
          x: 1.02,
          y: 0.5,
          font: {
            size: 14,
            family: "Arial Black, Arial, sans-serif",
            color: "#000"
          }
        },
        margin: { t: 80, b: 20, l: 20, r: 100 }
      };
      Plotly.newPlot("chartResumenEstado", [trace], layout, {
        responsive: true,
        displayModeBar: false
      });
    }

    // ----------------------------------------------------------
    // 6) Cerrar modal
    // ----------------------------------------------------------
    document.getElementById("modalClose").addEventListener("click", () => {
      document.getElementById("productModal").style.display = "none";
    });
    window.addEventListener("click", (e) => {
      const modal = document.getElementById("productModal");
      if (e.target === modal) modal.style.display = "none";
    });
  </script>
</body>
</html>

